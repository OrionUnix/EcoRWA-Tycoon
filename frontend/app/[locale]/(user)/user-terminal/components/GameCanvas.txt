'use client';

import React, { useRef, useEffect, useState } from 'react';
import * as PIXI from 'pixi.js';

// Hooks
import { usePixiApp } from '../hooks/usePixiApp';
import { useGameLoop } from '../hooks/useGameLoop';
import { useGameInput } from '../hooks/useGameInput';

// Moteur & Types
import { getGameEngine } from '../engine/GameEngine';
import { RoadType, ZoneType } from '../engine/types';

interface GameCanvasProps {
    viewMode: string;
    selectedRoad: RoadType;
    selectedZone: ZoneType;
    // ... autres props si besoin
    setFps: (fps: number) => void;
    setResources: (res: any) => void;
    setStats: (stats: any) => void;
    // Callbacks
    setCursorPos: (pos: { x: number, y: number }) => void;
    setHoverInfo: (info: any) => void;
    setTotalCost: (cost: number) => void;
    setIsValidBuild: (valid: boolean) => void;
}

export default function GameCanvas({
    viewMode, selectedRoad, selectedZone,
    setFps, setResources, setStats,
    setCursorPos, setHoverInfo, setTotalCost, setIsValidBuild
}: GameCanvasProps) {

    // âœ… 1. REFERENCE DU CONTENEUR (Initiale null, c'est normal)
    const containerRef = useRef<HTMLDivElement>(null);

    // 2. PIXI APP (Accepte maintenant le null grÃ¢ce Ã  l'Ã©tape 1)
    const { appRef, stageRef, isReady } = usePixiApp(containerRef);

    const terrainContainerRef = useRef<PIXI.Container | null>(null);
    const staticGRef = useRef<PIXI.Graphics | null>(null);
    const uiGRef = useRef<PIXI.Graphics | null>(null);

    const previewPathRef = useRef<number[]>([]);
    const isValidBuildRef = useRef(true);

    // 3. INITIALISATION DES CALQUES
    useEffect(() => {
        if (isReady && stageRef.current && !staticGRef.current) {
            console.log("ðŸŽ¨ GameCanvas: CrÃ©ation des Layers...");
            const terrain = new PIXI.Container();
            const staticG = new PIXI.Graphics();
            const uiG = new PIXI.Graphics();

            stageRef.current.addChild(terrain);
            stageRef.current.addChild(staticG);
            stageRef.current.addChild(uiG);

            terrainContainerRef.current = terrain;
            staticGRef.current = staticG;
            uiGRef.current = uiG;
        }
    }, [isReady]);

    // 4. BOUCLE DE JEU
    useGameLoop(
        appRef, terrainContainerRef, staticGRef, uiGRef, isReady,
        viewMode, { x: 0, y: 0 }, previewPathRef, isValidBuildRef,
        setFps, setResources, setStats
    );

    // 5. INPUTS
    useGameInput(
        stageRef, appRef, isReady, viewMode, selectedRoad, selectedZone,
        setCursorPos, setHoverInfo, setTotalCost, setIsValidBuild,
        previewPathRef, isValidBuildRef
    );

    // âœ… IMPORTANT : Le div doit avoir une taille !
    return (
        <div
            ref={containerRef}
            className="w-full h-full bg-black"
            style={{ minHeight: '100vh', minWidth: '100vw' }}
        />
    );
}